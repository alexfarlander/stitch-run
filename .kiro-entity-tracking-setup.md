# Entity Tracking System - Setup Notes

## Completed Tasks

### Task 1: Update type definitions and database schema ✅

All subtasks have been completed:

#### 1.1 Update StitchEntity interface in types ✅
- Added `current_edge_id`, `edge_progress` fields to `StitchEntity` interface
- Created `JourneyEvent` interface with all event types
- Created `JourneyEdgeData` interface for edge statistics
- Location: `stitch-run/src/types/stitch.ts`

#### 1.2 Create database migration for entity position tracking ✅
- Created migration `004_entity_position_tracking.sql`
- Adds `current_edge_id` and `edge_progress` columns to `stitch_entities` table
- Adds constraint to ensure progress is between 0.0 and 1.0
- Adds constraint to ensure position exclusivity (node OR edge, not both)
- Adds index on `current_edge_id` for efficient queries
- Location: `stitch-run/supabase/migrations/004_entity_position_tracking.sql`

#### 1.3 Create stitch_journey_events table ✅
- Created migration `005_journey_events_table.sql`
- Creates table with id, entity_id, event_type, node_id, edge_id, progress, metadata, timestamp
- Adds foreign key constraint to stitch_entities with CASCADE delete
- Adds indexes on entity_id, timestamp, event_type, edge_id
- Enables Supabase realtime publication
- Location: `stitch-run/supabase/migrations/005_journey_events_table.sql`

#### 1.4 & 1.5 Property tests for position tracking ✅
- Created comprehensive property-based tests using fast-check
- Tests Property 1: Position mutual exclusivity
- Tests Property 2: Edge progress bounds
- Location: `stitch-run/src/lib/db/__tests__/entity-position.property.test.ts`

## Migrations Applied

The migrations have been applied to the cloud database using:
```bash
npx tsx scripts/apply-entity-migrations.ts
```

**Note:** Migration 005 was updated after initial application to add an index on `node_id`. This additional index should be applied manually via the Supabase SQL editor:
```sql
CREATE INDEX IF NOT EXISTS idx_journey_events_node_id ON stitch_journey_events(node_id);
```

## Important Note: Supabase Schema Cache

The database migrations have been successfully applied, but Supabase's PostgREST API layer caches the database schema. The new columns (`current_edge_id`, `edge_progress`) exist in the database but may not be immediately visible to the API.

### To Refresh the Schema Cache:

**Option 1: Wait (Recommended)**
- The schema cache typically refreshes automatically within 5-10 minutes

**Option 2: Manual Refresh via Supabase Dashboard**
1. Go to your Supabase project dashboard
2. Navigate to the API section
3. Click "Reload schema" or restart the PostgREST service

**Option 3: Restart the Project**
- In the Supabase dashboard, you can pause and resume the project to force a full refresh

### Verifying the Schema is Ready

Run the property tests to verify the schema cache has been refreshed:
```bash
npx vitest run src/lib/db/__tests__/entity-position.property.test.ts
```

When the schema cache is refreshed, the tests should pass successfully.

## Next Steps

Once the schema cache is refreshed and the property tests pass:
1. Proceed to Task 2: Implement entity movement API functions
2. The type definitions are ready to use
3. The database schema supports all required entity tracking features

## Files Created/Modified

### Created:
- `stitch-run/supabase/migrations/004_entity_position_tracking.sql`
- `stitch-run/supabase/migrations/005_journey_events_table.sql`
- `stitch-run/src/lib/db/__tests__/entity-position.property.test.ts`
- `stitch-run/scripts/apply-entity-migrations.ts`

### Modified:
- `stitch-run/src/types/stitch.ts` - Added entity tracking interfaces
